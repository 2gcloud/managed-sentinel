{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "rgName": {
            "type": "string",
            "defaultValue": "rg-managed-sentinel-companyname"
        },
        "location": {
            "type": "string"
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the Log Analytics workspace"
            },
            "defaultValue": "rg-managed-sentinel-companyname-law"
        },
        "pricingTierLA": {
            "type": "string",
            "metadata": {
                "description": "Pricing tier: pergb2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
            },
            "allowedValues": [
                "CapacityReservation",
                "Free",
                "LACluster",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
            ],
            "defaultValue": "PerGB2018"
        },
        "capacityReservationLA": {
            "type": "int",
            "metadata": {
                "description": "Commitment tier"
            },
            "allowedValues": [
                100,
                200,
                300,
                400,
                500,
                1000,
                2000,
                5000
            ],
            "defaultValue": 100
        },
        "pricingTierSentinel": {
            "type": "string",
            "metadata": {
                "description": "Pricing tier: pergb2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
            },
            "allowedValues": [
                "CapacityReservation",
                "PerGB"
            ],
            "defaultValue": "PerGB"
        },
        "capacityReservationSentinel": {
            "type": "int",
            "metadata": {
                "description": "Commitment tier"
            },
            "allowedValues": [
                100,
                200,
                300,
                400,
                500,
                1000,
                2000,
                5000
            ],
            "defaultValue": 100
        },
        "enableDataConnectors": {
            "type": "array",
            "metadata": {
                "description": "The kind of data connectors that can be deployed via ARM templates are the following: [\"AzureActivityLog\",\"SecurityInsightsSecurityEventCollectionConfiguration\",\"WindowsFirewall\",\"DnsAnalytics\"], Reference: https://docs.microsoft.com/azure/templates/microsoft.operationalinsights/2020-03-01-preview/workspaces/datasources#microsoftoperationalinsightsworkspacesdatasources-object"
            },
            "defaultValue": []
        },
        "severityLevels": {
            "type": "array",
            "metadata": {
                "description": "Severity levels desired for Analytics Rules"
            },
            "defaultValue": ["None"]
        },
        "dailyQuota": {
            "type": "int",
            "metadata": {
                "description": "Daily ingestion limit in GBs. This limit doesn't apply to the following tables: SecurityAlert, SecurityBaseline, SecurityBaselineSummary, SecurityDetection, SecurityEvent, WindowsFirewall, MaliciousIPCommunication, LinuxAuditLog, SysmonEvent, ProtectionStatus, WindowsEvent"
            }
        },
        "dataRetention": {
            "type": "int",
            "minValue": 7,
            "maxValue": 730,
            "metadata": {
                "description": "Number of days of retention. Workspaces in the legacy Free pricing tier can only have 7 days."
            },
            "defaultValue": 90
        },
        "immediatePurgeDataOn30Days": {
            "type": "bool",
            "metadata": {
                "description": "If set to true when changing retention to 30 days, older data will be immediately deleted. Use this with extreme caution. This only applies when retention is being set to 30 days."
            },
            "defaultValue": true
        },
        "enableSolutions1P": {
            "type": "array",
            "metadata": {
                "description": "The list of Content Hub 1st party solutions to deploy."
            },
            "defaultValue": []
        },
        "enableSolutionsEssentials": {
            "type": "array",
            "metadata": {
                "description": "The list of Content Hub Essentials solutions to deploy."
            },
            "defaultValue": []
        },
        "enableSolutionsTraining": {
            "type": "array",
            "metadata": {
                "description": "The list of Content Hub Training solutions to deploy."
            },
            "defaultValue": []
        },
        "aadStreams": {
            "type": "array",
            "metadata": {
                "description": "The list of data types to enable for Azure AD connector"
            },
            "defaultValue": []
        },
        "enableUeba": {
            "type": "bool",
            "metadata": {
                "description": "Whether or not UEBA should be enabled"
            },
            "defaultValue": true
        },
        "identityProviders": {
            "type": "array",
            "metadata": {
                "description": "Array of identity providers to be synched with UEBA. Valid identity providers are 'ActiveDirectory' and 'AzureActiveDirectory'"
            },
            "defaultValue": []
        },
        "enableDiagnostics": {
            "type": "bool"
        },
        "enableScheduledAlerts": {
            "type": "bool",
            "metadata": {
                "description": "Enable Scheduled analytics rules"
            },
            "defaultValue": false
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources"
            },
            "defaultValue": "https://raw.githubusercontent.com/2gcloud/managed-sentinel/main/"
        },
        "mspOfferName": {
            "type": "string",
            "metadata": {
                "description": "Specify a unique name for your offer"
            },
            "defaultValue": "2G Cloud Managed Sentinel"
        },
        "mspOfferDescription": {
            "type": "string",
            "metadata": {
                "description": "Description of the Managed Service Provider offering"
            },
            "defaultValue": "2G Cloud's Managed Sentinel solution. 2G Cloud is given access to log data stored in your own tenant. The data is processed by 2G Cloud analytics rules but is not exported from the tenant."
        },
        "managedByTenantId": {
            "type": "string",
            "metadata": {
                "description": "Specify the tenant id of the Managed Service Provider"
            },
            "defaultValue": "4843dccc-9d7b-403f-b1c5-5592fdb9bda1"
        },
        "authorizations": {
            "type": "array",
            "metadata": {
                "description": "Specify an array of objects, containing tuples of Azure Active Directory principalId, a Azure roleDefinitionId, and an optional principalIdDisplayName. The roleDefinition specified is granted to the principalId in the provider's Active Directory and the principalIdDisplayName is visible to customers."
            },
            "defaultValue": [
                { 
                    "principalId": "fcd96a3b-ffb2-4c6f-9f6e-204eaf6e733e", 
                    "roleDefinitionId": "ab8e14d6-4a74-4a29-9ba8-549422addade",
                    "principalIdDisplayName": "Managed Sentinel Security Engineer" 
                }, 
                { 
                    "principalId": "fcd96a3b-ffb2-4c6f-9f6e-204eaf6e733e", 
                    "roleDefinitionId": "87a39d53-fc1b-424a-814c-f7e04687dc9e",
                    "principalIdDisplayName": "Managed Sentinel Security Engineer" 
                }, 
                { 
                    "principalId": "fcd96a3b-ffb2-4c6f-9f6e-204eaf6e733e", 
                    "roleDefinitionId": "91c1777a-f3dc-4fae-b103-61d183457e46",
                    "principalIdDisplayName": "Managed Sentinel Security Engineer" 
                }, 
                { 
                    "principalId": "a767fbc1-febe-4884-a588-2f19d986b4ec", 
                    "roleDefinitionId": "3e150937-b8fe-4cfb-8069-0eaf05ecd056",
                    "principalIdDisplayName": "Managed Sentinel Security Responders" 
                }
            ]
        }        
    },
    "variables": {
        "mspRegistrationName": "[string(guid(parameters('mspOfferName')))]",
        "mspAssignmentName": "[string(guid(parameters('mspOfferName')))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[parameters('rgName')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.ManagedServices/registrationDefinitions",
            "apiVersion": "2019-06-01",
            "name": "[variables('mspRegistrationName')]",
            "scope": "[concat('Microsoft.Resources/resourceGroups/',parameters('rgName'))]",
            "properties": {
                "registrationDefinitionName": "[parameters('mspOfferName')]",
                "description": "[parameters('mspOfferDescription')]",
                "managedByTenantId": "[parameters('managedByTenantId')]",
                "authorizations": "[parameters('authorizations')]"
            }
        },
        {
            "name": "lighthouseDelegation",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]",
                "[resourceId('Microsoft.ManagedServices/registrationDefinitions/', variables('mspRegistrationName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/azureLighthouseDelegation.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "mspRegistrationName": {
                        "value": "[variables('mspRegistrationName')]"
                    },
                    "mspAssignmentName": {
                        "value": "[variables('mspAssignmentName')]"
                    },
                    "scope": {
                        "value": "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
                    }
                }
            }
        },
        {
            "name": "workspaceCreation",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/workspace.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "pricingTierLA": {
                        "value": "[parameters('pricingTierLA')]"
                    },
                    "pricingTierSentinel": {
                        "value": "[parameters('pricingTierSentinel')]"
                    },
                    "dailyQuota": {
                        "value": "[parameters('dailyQuota')]"
                    },
                    "dataRetention": {
                        "value": "[parameters('dataRetention')]"
                    },
                    "immediatePurgeDataOn30Days": {
                        "value": "[parameters('immediatePurgeDataOn30Days')]"
                    },
                    "capacityReservationLA": {
                        "value": "[parameters('capacityReservationLA')]"
                    },
                    "capacityReservationSentinel": {
                        "value": "[parameters('capacityReservationSentinel')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "settings",
            "apiVersion": "2020-06-01",
            "dependsOn": [
                "workspaceCreation"
            ],
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/settings.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "enableUeba": {
                        "value": "[parameters('enableUeba')]"
                    },
                    "identityProviders": {
                        "value": "[parameters('identityProviders')]"
                    },
                    "enableDiagnostics": {
                        "value": "[parameters('enableDiagnostics')]"
                    }
                }
            }
        },
        {
            "condition": "[not(empty(parameters('enableDataConnectors')))]",
            "name": "enableDataConnectors",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "workspaceCreation",
                "enableSolutionsAndAlerts"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/dataConnectors.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "dataConnectorsKind": {
                        "value": "[parameters('enableDataConnectors')]"
                    },
                    "aadStreams": {
                        "value": "[parameters('aadStreams')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "tenantId": {
                        "value": "[subscription().tenantId]"
                    },
                    "subscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "condition": "[or(not(empty(parameters('enableSolutions1P'))),not(empty(parameters('enableSolutionsEssentials'))),not(empty(parameters('enableSolutionsTraining'))))]",
            "name": "enableSolutionsAndAlerts",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "workspaceCreation",
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'LinkedTemplates/solutionsAndAlerts.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "enableSolutions1P": {
                        "value": "[replace(replace(string(parameters('enableSolutions1P')),'[',''),']','')]"
                    },
                    "enableSolutionsEssentials": {
                        "value": "[replace(replace(string(parameters('enableSolutionsEssentials')),'[',''),']','')]"
                    },
                    "enableSolutionsTraining": {
                        "value": "[replace(replace(string(parameters('enableSolutionsTraining')),'[',''),']','')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "severityLevels": {
                        "value": "[replace(replace(string(parameters('severityLevels')),'[',''),']','')]"
                    },
                    "enableAlerts": {
                        "value": "[parameters('enableScheduledAlerts')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "workspaceName": {
            "type": "string",
            "value": "[parameters('workspaceName')]"
        },
        "dataConnectorsList": {
            "type": "string",
            "value": "[replace(replace(string(parameters('enableDataConnectors')),'\"',''),'[','')]"
        }
    }
}
